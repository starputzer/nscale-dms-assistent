<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nscale DMS Assistent</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --nscale-green: #00a550; /* Hauptgrün von nscale */
            --nscale-green-dark: #009046; /* Dunkleres Grün für Hover */
            --nscale-light-green: #e8f7ef; /* Helles Grün für Hintergründe */
            --nscale-gray: #f7f7f7; /* Hellgrau für Hintergründe */
            --nscale-dark-gray: #333333; /* Für Text */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--nscale-dark-gray);
            background-color: white;
        }

        .nscale-btn-primary {
            background-color: var(--nscale-green);
            color: white;
            border-radius: 4px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .nscale-btn-primary:hover {
            background-color: var(--nscale-green-dark);
        }

        .nscale-btn-secondary {
            background-color: white;
            color: var(--nscale-green);
            border: 1px solid var(--nscale-green);
            border-radius: 4px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }

        .nscale-btn-secondary:hover {
            background-color: var(--nscale-light-green);
        }

        .nscale-input {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            transition: border-color 0.3s;
        }

        .nscale-input:focus {
            border-color: var(--nscale-green);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 165, 80, 0.1);
        }

        .nscale-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .nscale-sidebar {
            background-color: var(--nscale-gray);
            border-right: 1px solid #eaeaea;
        }

        .nscale-message-user {
            background-color: var(--nscale-light-green);
            border-radius: 8px;
            border-top-right-radius: 2px;
            padding: 1rem;
            max-width: 80%;
            margin-left: auto;
            margin-right: 0;
        }

        .nscale-message-assistant {
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            border-top-left-radius: 2px;
            padding: 1rem;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nscale-session-item {
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }

        .nscale-session-item:hover {
            background-color: #e9e9e9;
        }

        .nscale-session-item.active {
            background-color: var(--nscale-light-green);
            border-left: 3px solid var(--nscale-green);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Logo-Bereich */
        .nscale-logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: var(--nscale-green);
        }

        .nscale-logo:before {
            content: '';
            display: inline-block;
            width: 28px;
            height: 28px;
            margin-right: 8px;
            background-color: var(--nscale-green);
            border-radius: 50%;
        }

        /* Moderne Schatten für Karten */
        .nscale-card {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            background-color: white;
            border: 1px solid #f0f0f0;
        }

        /* Chat-Bereich */
        .chat-container {
            height: calc(100vh - 180px);
            display: flex;
            flex-direction: column;
        }
        
        .message-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .input-container {
            padding: 1rem;
            border-top: 1px solid #eaeaea;
            background-color: white;
        }

        /* Farbakzente für Links und Fokus */
        .text-nscale {
            color: var(--nscale-green);
        }
        
        .hover\:text-nscale-dark:hover {
            color: var(--nscale-green-dark);
        }
        
        .border-nscale {
            border-color: var(--nscale-green);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app" class="h-screen flex flex-col">
        <!-- Login & Register -->
        <div v-if="!token" class="flex items-center justify-center h-full bg-gray-50">
            <div class="nscale-card max-w-md w-full p-8">
                <div class="text-center mb-8">
                    <div class="nscale-logo mx-auto">nscale DMS Assistent</div>
                    <p class="text-gray-500 mt-2">Ihr Digitalisierungspartner für DMS-Lösungen</p>
                </div>
                
                <div class="flex border-b border-gray-200 mb-6">
                    <button @click="authMode = 'login'" 
                        :class="['py-2 px-4 w-1/2 text-center focus:outline-none', 
                        authMode === 'login' ? 'border-b-2 border-green-500 text-green-600 font-medium' : 'text-gray-500']">
                        Anmelden
                    </button>
                    <button @click="authMode = 'register'" 
                        :class="['py-2 px-4 w-1/2 text-center focus:outline-none', 
                        authMode === 'register' ? 'border-b-2 border-green-500 text-green-600 font-medium' : 'text-gray-500']">
                        Registrieren
                    </button>
                </div>
                
                <!-- Login Form -->
                <form v-if="authMode === 'login'" @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Passwort</label>
                        <input v-model="password" class="nscale-input w-full" 
                            id="password" type="password" placeholder="Ihr Passwort" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Anmelden</span>
                            <span v-else>Anmelden</span>
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <a class="text-sm text-nscale hover:text-nscale-dark" href="#" @click.prevent="authMode = 'reset'">
                            Passwort vergessen?
                        </a>
                    </div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
                
                <!-- Register Form -->
                <form v-if="authMode === 'register'" @submit.prevent="register" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reg-email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="reg-email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reg-password">Passwort</label>
                        <input v-model="password" class="nscale-input w-full" 
                            id="reg-password" type="password" placeholder="Ihr sicheres Passwort" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Registrieren</span>
                            <span v-else>Registrieren</span>
                        </button>
                    </div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
                
                <!-- Reset Password Form -->
                <form v-if="authMode === 'reset'" @submit.prevent="resetPassword" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reset-email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="reset-email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Passwort zurücksetzen</span>
                            <span v-else>Passwort zurücksetzen</span>
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <a class="text-sm text-nscale hover:text-nscale-dark" href="#" @click.prevent="authMode = 'login'">
                            Zurück zur Anmeldung
                        </a>
                    </div>
                    <div v-if="successMessage" class="mt-4 text-green-600 text-sm text-center">{{ successMessage }}</div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
            </div>
        </div>
        
        <!-- Main Chat Interface -->
        <div v-if="token" class="flex flex-col h-screen">
            <!-- Header -->
            <header class="nscale-header p-4">
                <div class="container mx-auto flex justify-between items-center">
                    <div class="nscale-logo">nscale DMS Assistent</div>
                    <div class="flex space-x-4">
                        <button @click="startNewSession" class="nscale-btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Neue Unterhaltung
                        </button>
                        <button @click="logout" class="nscale-btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Abmelden
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Main Content -->
            <div class="flex flex-1 overflow-hidden container mx-auto my-4">
                <!-- Sessions Sidebar -->
                <aside class="nscale-sidebar w-80 p-4 rounded-l-lg overflow-y-auto">
                    <h2 class="text-lg font-medium mb-6 text-gray-700">Unterhaltungen</h2>
                    <ul class="space-y-2">
                        <li v-for="session in sessions" :key="session.id" 
                            @click="loadSession(session.id)"
                            :class="['nscale-session-item cursor-pointer', 
                            currentSessionId === session.id ? 'active' : '']">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    <span class="truncate">{{ session.title }}</span>
                                </div>
                                <button @click.stop="deleteSession(session.id)" class="text-gray-400 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </li>
                    </ul>
                </aside>
                
                <!-- Chat Area -->
                <main class="nscale-card flex-1 flex flex-col bg-white overflow-hidden rounded-r-lg ml-4">
                    <div v-if="!currentSessionId" class="flex h-full items-center justify-center text-gray-400 p-8">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <h3 class="text-lg font-medium mb-2">Keine Unterhaltung ausgewählt</h3>
                            <p class="text-sm text-gray-500 mb-4">Wählen Sie eine Unterhaltung aus der Seitenleiste oder starten Sie eine neue.</p>
                            <button @click="startNewSession" class="nscale-btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Neue Unterhaltung starten
                            </button>
                        </div>
                    </div>
                    
                    <div v-else class="chat-container">
                        <!-- Chat Messages -->
                        <div class="message-container" ref="chatMessages">
                            <div v-for="(message, index) in messages" :key="index" class="mb-6">
                                <div :class="[message.is_user ? 'nscale-message-user' : 'nscale-message-assistant']">
                                    <div v-html="formatMessage(message.message)" class="prose"></div>
                                </div>
                            </div>
                            <div v-if="isLoading" class="flex justify-center p-4">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div class="input-container bg-white">
                            <form @submit.prevent="sendQuestionStream" class="flex space-x-2">
                                <input v-model="question" class="nscale-input flex-1" 
                                    placeholder="Stellen Sie Ihre Frage zur nscale DMS-Software..." 
                                    :disabled="!currentSessionId || isLoading" />
                                <button type="submit" class="nscale-btn-primary"
                                    :disabled="!currentSessionId || !question || isLoading">
                                    <span v-if="isLoading">
                                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Wird gesendet...
                                    </span>
                                    <span v-else>Senden</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <script>
        const { createApp, ref, onMounted, watch, nextTick } = Vue;
        
        createApp({
            setup() {
                // Authentication state
                const token = ref(localStorage.getItem('token') || '');
                const email = ref('');
                const password = ref('');
                const authMode = ref('login');
                const loading = ref(false);
                const errorMessage = ref('');
                const successMessage = ref('');
                
                // Chat state
                const sessions = ref([]);
                const currentSessionId = ref(null);
                const messages = ref([]);
                const question = ref('');
                const isLoading = ref(false);
                const chatMessages = ref(null);
                const isStreaming = ref(false);
                const eventSource = ref(null);

                // Setup axios with auth header
                const setupAxios = () => {
                    axios.defaults.headers.common['Authorization'] = token.value ? `Bearer ${token.value}` : '';
                };
                
                const cleanupStream = () => {
                    eventSource.value?.close();
                    eventSource.value = null;
                    isLoading.value = false;
                    isStreaming.value = false;
                    question.value = '';
                };

                // Optimierte StreamingFunktion mit EventSource und verbessertem Event-Handling
                const sendQuestionStream = async () => {
                    if (!question.value.trim() || !currentSessionId.value) return;
                    // Überprüfe, ob die Frage gesetzt ist
                    if (!question.value) {
                        console.error("Frage ist leer.");
                        return;
                    }
                    try {
                        isLoading.value = true;
                        isStreaming.value = true;

                        // Füge Benutzernachricht sofort hinzu (bessere UX)
                        messages.value.push({
                            is_user: true,
                            message: question.value,
                            timestamp: Date.now() / 1000
                        });

                        // Bereite einen Platz für die Assistentennachricht vor
                        const assistantIndex = messages.value.length;
                        messages.value.push({
                            is_user: false,
                            message: '',
                            timestamp: Date.now() / 1000
                        });

                        await nextTick();
                        scrollToBottom();

                        // Alte EventSource schließen, falls vorhanden
                        if (eventSource.value) {
                            eventSource.value.close();
                        }

                        // URL mit Parametern erstellen
                        const url = new URL('/api/question/stream', window.location.origin);
                        url.searchParams.append('question', question.value);
                        url.searchParams.append('session_id', currentSessionId.value);
                        
                        // Token als URL-Parameter hinzufügen (ohne "Bearer " Präfix)
                        const authToken = token.value.replace('Bearer ', '');
                        url.searchParams.append('auth_token', authToken);

                        // Neue EventSource erstellen
                        eventSource.value = new EventSource(url.toString());

                        // Debugginginformationen
                        console.log('EventSource verbunden mit:', url.toString());

                        // Standard-Nachrichtenereignis - normaler Datenfluss
                        // eventSource.value.onmessage = (event) => {
                        //     console.log('Nachricht erhalten:', event.data);
                        //     if (event.data) {
                        //         try {
                        //             const parsed = JSON.parse(event.data);
                        //             if (parsed.error) {
                        //                 messages.value[assistantIndex].message = parsed.error;
                        //                 eventSource.value.close();
                        //                 isLoading.value = false;
                        //                 isStreaming.value = false;
                        //                 question.value = '';
                        //                 eventSource.value = null;
                        //                 return;
                        //             }
                        //         } catch (e) {
                        //             // Keine JSON, einfach normal anhängen
                        //             messages.value[assistantIndex].message += event.data;
                        //             scrollToBottom();
                        //         }
                        //     }
                        // };
                        eventSource.value.onmessage = (event) => {
                            console.log('Nachricht erhalten:', event.data);
                            if (event.data) {
                                try {
                                    const parsed = JSON.parse(event.data);
                                    if (parsed.error) {
                                        messages.value[assistantIndex].message = '[Fehler]: ' + parsed.error;
                                        cleanupStream();
                                        return;
                                    } else if (parsed.response) {
                                        messages.value[assistantIndex].message += parsed.response;
                                    }
                                } catch (e) {
                                    // Nicht-JSON-Daten anhängen
                                    messages.value[assistantIndex].message += event.data;
                                }
                                scrollToBottom();
                            }
                        };

// Bei jedem Ereignistyp
// eventSource.value.addEventListener('message', (event) => {
//     console.log('message event:', event.data);
//     if (event.data) {
//         messages.value[assistantIndex].message += event.data;
//         scrollToBottom();
//     }
// });

                        // Bei jedem Ereignistyp
                        eventSource.value.addEventListener('message', (event) => {
                            console.log('message event:', event.data);
                            if (event.data) {
                                messages.value[assistantIndex].message += event.data;
                                scrollToBottom();
                            }
                        });

                        // Bei "done" Event
                        eventSource.value.addEventListener('done', (event) => {
                            console.log('done event erhalten');
                            eventSource.value.close();
                            isLoading.value = false;
                            isStreaming.value = false;
                            question.value = ''; // Eingabefeld leeren
                            eventSource.value = null;
                        });

                        // Bei einem Fehler
                        eventSource.value.onerror = (event) => {
                            console.error('SSE-Fehler:', event);
                            if (messages.value[assistantIndex]?.message === '') {
                                messages.value[assistantIndex].message = 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.';
                            }
                            
                            eventSource.value.close();
                            isLoading.value = false;
                            isStreaming.value = false;
                            eventSource.value = null;
                        };

                    } catch (error) {
                        console.error('Streaming-Fehler:', error);
                        isLoading.value = false;
                        isStreaming.value = false;
                        
                        // Fehler-Nachricht hinzufügen
                        if (messages.value.length > 0 && !messages.value[messages.value.length - 1].is_user) {
                            messages.value[messages.value.length - 1].message = 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.';
                        } else {
                            messages.value.push({
                                is_user: false,
                                message: 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.',
                                timestamp: Date.now() / 1000
                            });
                        }
                    }
                };
                
                // Herkömmliche Anfrage (als Fallback)
                const sendQuestion = async () => {
                    if (!question.value.trim() || !currentSessionId.value) {
                        return;
                    }
                    
                    try {
                        isLoading.value = true;
                        
                        // Add user message immediately for better UX
                        messages.value.push({
                            is_user: true,
                            message: question.value,
                            timestamp: Date.now() / 1000
                        });
                        
                        await nextTick();
                        scrollToBottom();
                        
                        const response = await axios.post('/api/question', {
                            question: question.value,
                            session_id: currentSessionId.value
                        });
                        
                        // Add assistant response
                        messages.value.push({
                            is_user: false,
                            message: response.data.answer,
                            timestamp: Date.now() / 1000
                        });
                        
                        // Clear input
                        question.value = '';
                        
                        await nextTick();
                        scrollToBottom();
                    } catch (error) {
                        console.error('Error sending question:', error);
                        
                        // Add error message
                        messages.value.push({
                            is_user: false,
                            message: 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.',
                            timestamp: Date.now() / 1000
                        });
                        
                        await nextTick();
                        scrollToBottom();
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                // Auth functions
                const login = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        
                        const response = await axios.post('/api/auth/login', {
                            email: email.value,
                            password: password.value
                        });
                        
                        token.value = response.data.token;
                        localStorage.setItem('token', token.value);
                        setupAxios();
                        
                        // Clear form
                        email.value = '';
                        password.value = '';
                        
                        // Load sessions
                        loadSessions();
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Anmeldefehler. Bitte versuchen Sie es erneut.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const register = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        
                        await axios.post('/api/auth/register', {
                            email: email.value,
                            password: password.value
                        });
                        
                        // Switch to login after successful registration
                        authMode.value = 'login';
                        successMessage.value = 'Registrierung erfolgreich. Bitte melden Sie sich an.';
                        
                        // Clear form
                        email.value = '';
                        password.value = '';
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Registrierungsfehler. Bitte versuchen Sie es erneut.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const resetPassword = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        successMessage.value = '';
                        
                        const response = await axios.post('/api/auth/reset-password', {
                            email: email.value
                        });
                        
                        successMessage.value = response.data.message;
                        
                        // In a real app, the user would receive an email with the token
                        // For this example, we'll show the token directly
                        if (response.data.token) {
                            successMessage.value += ` Token: ${response.data.token}`;
                        }
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Fehler beim Zurücksetzen des Passworts.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('token');
                    setupAxios();
                    currentSessionId.value = null;
                    sessions.value = [];
                    messages.value = [];
                    
                    // EventSource schließen, falls vorhanden
                    if (eventSource.value) {
                        eventSource.value.close();
                        eventSource.value = null;
                    }
                };
                
                // Session management
                const loadSessions = async () => {
                    try {
                        const response = await axios.get('/api/sessions');
                        sessions.value = response.data.sessions;
                    } catch (error) {
                        console.error('Error loading sessions:', error);
                    }
                };
                
                const loadSession = async (sessionId) => {
                    try {
                        isLoading.value = true;
                        const response = await axios.get(`/api/session/${sessionId}`);
                        currentSessionId.value = sessionId;
                        messages.value = response.data.messages;
                        
                        // Scroll to bottom after messages load
                        await nextTick();
                        scrollToBottom();
                    } catch (error) {
                        console.error('Error loading session:', error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                const startNewSession = async () => {
                    try {
                        isLoading.value = true;
                        const response = await axios.post('/api/session', {
                            title: "Neue Unterhaltung"
                        });
                        
                        await loadSessions();
                        await loadSession(response.data.session_id);
                    } catch (error) {
                        console.error('Error starting new session:', error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                const deleteSession = async (sessionId) => {
                    if (!confirm('Möchten Sie diese Unterhaltung wirklich löschen?')) {
                        return;
                    }
                    
                    try {
                        await axios.delete(`/api/session/${sessionId}`);
                        
                        if (currentSessionId.value === sessionId) {
                            currentSessionId.value = null;
                            messages.value = [];
                        }
                        
                        await loadSessions();
                    } catch (error) {
                        console.error('Error deleting session:', error);
                    }
                };
                
                const formatMessage = (text) => {
                    return marked.parse(text);
                };
                
                const scrollToBottom = () => {
                    if (chatMessages.value) {
                        chatMessages.value.scrollTop = chatMessages.value.scrollHeight;
                    }
                };
                
                // Initialize
                onMounted(() => {
                    setupAxios();
                    
                    if (token.value) {
                        loadSessions();
                    }
                    
                    // Clear messages when auth state changes
                    watch(token, (newValue) => {
                        if (!newValue) {
                            messages.value = [];
                            currentSessionId.value = null;
                        }
                    });
                    
                    // Clear error message when auth mode changes
                    watch(authMode, () => {
                        errorMessage.value = '';
                        successMessage.value = '';
                    });
                    
                    // EventSource bereinigen, wenn die Komponente zerstört wird
                    window.addEventListener('beforeunload', () => {
                        if (eventSource.value) {
                            eventSource.value.close();
                        }
                    });
                });
                
                return {
                    // Auth state
                    token,
                    email,
                    password,
                    authMode,
                    loading,
                    errorMessage,
                    successMessage,
                    
                    // Auth functions
                    login,
                    register,
                    resetPassword,
                    logout,
                    
                    // Chat state
                    sessions,
                    currentSessionId,
                    messages,
                    question,
                    isLoading,
                    chatMessages,
                    isStreaming,
                    
                    // Chat functions
                    sendQuestionStream,
                    sendQuestion,
                    loadSessions,
                    loadSession,
                    startNewSession,
                    deleteSession,
                    formatMessage,
                    scrollToBottom
                };
            }
        }).mount('#app');
    </script>
</body>
</html>