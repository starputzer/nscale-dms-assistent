<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nscale DMS Assistent</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --nscale-green: #00a550; /* Hauptgrün von nscale */
            --nscale-green-dark: #009046; /* Dunkleres Grün für Hover */
            --nscale-light-green: #e8f7ef; /* Helles Grün für Hintergründe */
            --nscale-gray: #f7f7f7; /* Hellgrau für Hintergründe */
            --nscale-dark-gray: #333333; /* Für Text */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--nscale-dark-gray);
            background-color: white;
        }

        .nscale-btn-primary {
            background-color: var(--nscale-green);
            color: white;
            border-radius: 4px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .nscale-btn-primary:hover {
            background-color: var(--nscale-green-dark);
        }

        .nscale-btn-secondary {
            background-color: white;
            color: var(--nscale-green);
            border: 1px solid var(--nscale-green);
            border-radius: 4px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }

        .nscale-btn-secondary:hover {
            background-color: var(--nscale-light-green);
        }

        .nscale-input {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            transition: border-color 0.3s;
        }

        .nscale-input:focus {
            border-color: var(--nscale-green);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 165, 80, 0.1);
        }

        .nscale-header {
            background-color: white;
            border-bottom: 1px solid #eaeaea;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }

        .nscale-sidebar {
            background-color: var(--nscale-gray);
            border-right: 1px solid #eaeaea;
        }

        .nscale-message-user {
            background-color: var(--nscale-light-green);
            border-radius: 8px;
            border-top-right-radius: 2px;
            padding: 1rem;
            max-width: 80%;
            margin-left: auto;
            margin-right: 0;
        }
        .nscale-message-system {
            background-color: var(--nscale-light-green);
            border: 1px solid var(--nscale-green);
            border-radius: 8px;
            padding: 1rem;
            max-width: 90%;
            margin: 1rem auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .nscale-message-assistant {
            background-color: white;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            border-top-left-radius: 2px;
            padding: 1rem;
            max-width: 80%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        /* Feedback-Button-Stile */
        .feedback-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.5rem;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .feedback-buttons:hover {
            opacity: 1;
        }
        
        .feedback-button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .feedback-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .feedback-button.selected {
            color: var(--nscale-green);
        }
        
        .feedback-button.selected.negative {
            color: #ef4444;
        }
        
        .feedback-comment {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.2rem;
            margin-right: 1rem;
        }
        .nscale-session-item {
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }

        .nscale-session-item:hover {
            background-color: #e9e9e9;
        }

        .nscale-session-item.active {
            background-color: var(--nscale-light-green);
            border-left: 3px solid var(--nscale-green);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Logo-Bereich */
        .nscale-logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: var(--nscale-green);
        }

        .nscale-logo:before {
            content: none;
        }

        /* Moderne Schatten für Karten */
        .nscale-card {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            background-color: white;
            border: 1px solid #f0f0f0;
        }

        /* Chat-Bereich */
        .chat-container {
            height: calc(100vh - 180px);
            display: flex;
            flex-direction: column;
        }
        
        .message-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .input-container {
            padding: 1rem;
            border-top: 1px solid #eaeaea;
            background-color: white;
        }

        /* Farbakzente für Links und Fokus */
        .text-nscale {
            color: var(--nscale-green);
        }
        
        .hover\:text-nscale-dark:hover {
            color: var(--nscale-green-dark);
        }
        
        .border-nscale {
            border-color: var(--nscale-green);
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <div id="app" class="h-screen flex flex-col">
        <!-- Login & Register -->
        <div v-if="!token" class="flex items-center justify-center h-full bg-gray-50">
            <div class="nscale-card max-w-md w-full p-8">
                <div class="text-center mb-8">
                    <div class="nscale-logo mx-auto">nscale DMS Assistent</div>
                    <p class="text-gray-500 mt-2">Ihr Digitalisierungspartner für DMS-Lösungen</p>
                </div>
                
                <div class="flex border-b border-gray-200 mb-6">
                    <button @click="authMode = 'login'" 
                        :class="['py-2 px-4 w-1/2 text-center focus:outline-none', 
                        authMode === 'login' ? 'border-b-2 border-green-500 text-green-600 font-medium' : 'text-gray-500']">
                        Anmelden
                    </button>
                    <button @click="authMode = 'register'" 
                        :class="['py-2 px-4 w-1/2 text-center focus:outline-none', 
                        authMode === 'register' ? 'border-b-2 border-green-500 text-green-600 font-medium' : 'text-gray-500']">
                        Registrieren
                    </button>
                </div>
                
                <!-- Login Form -->
                <form v-if="authMode === 'login'" @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="password">Passwort</label>
                        <input v-model="password" class="nscale-input w-full" 
                            id="password" type="password" placeholder="Ihr Passwort" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Anmelden</span>
                            <span v-else>Anmelden</span>
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <a class="text-sm text-nscale hover:text-nscale-dark" href="#" @click.prevent="authMode = 'reset'">
                            Passwort vergessen?
                        </a>
                    </div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
                
                <!-- Register Form -->
                <form v-if="authMode === 'register'" @submit.prevent="register" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reg-email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="reg-email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reg-password">Passwort</label>
                        <input v-model="password" class="nscale-input w-full" 
                            id="reg-password" type="password" placeholder="Ihr sicheres Passwort" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Registrieren</span>
                            <span v-else>Registrieren</span>
                        </button>
                    </div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
                
                <!-- Reset Password Form -->
                <form v-if="authMode === 'reset'" @submit.prevent="resetPassword" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="reset-email">E-Mail</label>
                        <input v-model="email" class="nscale-input w-full" 
                            id="reset-email" type="email" placeholder="Ihre E-Mail-Adresse" required>
                    </div>
                    <div class="flex items-center justify-between mt-6">
                        <button class="nscale-btn-primary w-full" 
                            type="submit" :disabled="loading">
                            <span v-if="loading" class="loading-dots">Passwort zurücksetzen</span>
                            <span v-else>Passwort zurücksetzen</span>
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <a class="text-sm text-nscale hover:text-nscale-dark" href="#" @click.prevent="authMode = 'login'">
                            Zurück zur Anmeldung
                        </a>
                    </div>
                    <div v-if="successMessage" class="mt-4 text-green-600 text-sm text-center">{{ successMessage }}</div>
                    <div v-if="errorMessage" class="mt-4 text-red-500 text-sm text-center">{{ errorMessage }}</div>
                </form>
            </div>
        </div>
        
        <!-- Main Chat Interface -->
        <header class="nscale-header p-4">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center">
                    <img src="/static/images/senmvku-logo.png" alt="Berlin Logo" class="h-16 mr-4">
                    <div class="nscale-logo">nscale DMS Assistent</div>
                </div>
                <div class="flex space-x-4">
                    <button @click="startNewSession" class="nscale-btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Neue Unterhaltung
                    </button>
                    <button @click="logout" class="nscale-btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Abmelden
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Fügen Sie einen neuen Tab für Feedback im Admin-Panel hinzu -->
        <div class="border-b border-gray-200 mb-6">
            <div class="flex">
                <button @click="adminTab = 'users'" 
                        :class="[adminTab === 'users' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                        'py-2 px-4 border-b-2 font-medium text-sm']">
                    Benutzerverwaltung
                </button>
                <button @click="adminTab = 'system'" 
                        :class="[adminTab === 'system' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                        'py-2 px-4 border-b-2 font-medium text-sm']">
                    Systemeinstellungen
                </button>
                <button @click="adminTab = 'feedback'" 
                        :class="[adminTab === 'feedback' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                        'py-2 px-4 border-b-2 font-medium text-sm']">
                    Feedback
                </button>
                <button @click="adminTab = 'logs'" 
                        :class="[adminTab === 'logs' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                        'py-2 px-4 border-b-2 font-medium text-sm']">
                    Logs & Statistiken
                </button>
            </div>
        </div>

        <!-- Feedback-Tab im Admin-Panel -->
        <div v-if="adminTab === 'feedback'">
            <h3 class="text-lg font-medium mb-4">Feedback-Übersicht</h3>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-medium mb-3">Statistik</h4>
                <div v-if="feedbackStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-3 rounded shadow">
                        <div class="text-sm text-gray-500">Gesamt</div>
                        <div class="text-xl font-semibold">{{ feedbackStats.total }}</div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <div class="text-sm text-gray-500">Positiv</div>
                        <div class="text-xl font-semibold text-green-600">{{ feedbackStats.positive }}</div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <div class="text-sm text-gray-500">Negativ</div>
                        <div class="text-xl font-semibold text-red-600">{{ feedbackStats.negative }}</div>
                    </div>
                    <div class="bg-white p-3 rounded shadow">
                        <div class="text-sm text-gray-500">Positiv %</div>
                        <div class="text-xl font-semibold">{{ feedbackStats.positive_percent }}%</div>
                    </div>
                </div>
                <div v-else class="text-center py-4 text-gray-500">
                    Keine Feedback-Daten verfügbar
                </div>
                <div class="
        <!-- Admin-Panel Button im Header (nur für Admins) -->
        <div v-if="userRole === 'admin'" class="flex space-x-4">
            <button @click="showAdminPanel = !showAdminPanel" class="nscale-btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Admin-Panel
            </button>
        </div>

        <!-- Admin-Panel Modal -->
        <div v-if="showAdminPanel" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg w-3/4 max-w-4xl max-h-3/4 overflow-hidden shadow-xl">
                <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800">Administrator-Bereich</h2>
                    <button @click="showAdminPanel = false" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-6 overflow-y-auto" style="max-height: 60vh;">
                    <!-- Tabs für verschiedene Admin-Funktionen -->
                    <div class="border-b border-gray-200 mb-6">
                        <div class="flex">
                            <button @click="adminTab = 'users'" 
                                    :class="[adminTab === 'users' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                                    'py-2 px-4 border-b-2 font-medium text-sm']">
                                Benutzerverwaltung
                            </button>
                            <button @click="adminTab = 'system'" 
                                    :class="[adminTab === 'system' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                                    'py-2 px-4 border-b-2 font-medium text-sm']">
                                Systemeinstellungen
                            </button>
                            <button @click="adminTab = 'logs'" 
                                    :class="[adminTab === 'logs' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500', 
                                    'py-2 px-4 border-b-2 font-medium text-sm']">
                                Logs & Statistiken
                            </button>
                        </div>
                    </div>
                    
                    <!-- Benutzer-Tab -->
                    <div v-if="adminTab === 'users'">
                        <h3 class="text-lg font-medium mb-4">Benutzerverwaltung</h3>
                        
                        <!-- Benutzer hinzufügen -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-medium mb-2">Neuen Benutzer erstellen</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input v-model="newUser.email" class="nscale-input col-span-1" placeholder="E-Mail" />
                                <input v-model="newUser.password" type="password" class="nscale-input col-span-1" placeholder="Passwort" />
                                <select v-model="newUser.role" class="nscale-input col-span-1">
                                    <option value="user">Benutzer</option>
                                    <option value="editor">Editor</option>
                                    <option value="admin">Administrator</option>
                                </select>
                            </div>
                            <button @click="createUser" class="nscale-btn-primary mt-3">Benutzer erstellen</button>
                        </div>
                        
                        <!-- Benutzerliste -->
                        <div v-if="adminUsers.length > 0">
                            <h4 class="font-medium mb-2">Benutzerliste</h4>
                            <div class="bg-white shadow overflow-x-auto rounded-lg">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-Mail</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rolle</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Erstellt</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Letzte Anm.</th>
                                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="user in adminUsers" :key="user.id">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.id }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.email }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <select v-model="user.role" @change="updateUserRole(user.id, user.role)" class="text-sm border-gray-300 rounded-md">
                                                    <option value="user">Benutzer</option>
                                                    <option value="editor">Editor</option>
                                                    <option value="admin">Administrator</option>
                                                </select>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {{ new Date(user.created_at * 1000).toLocaleString() }}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                {{ user.last_login ? new Date(user.last_login * 1000).toLocaleString() : 'Nie' }}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button @click="deleteUser(user.id)" class="text-red-600 hover:text-red-900">Löschen</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div v-else class="text-center text-gray-500">
                            Keine Benutzer gefunden oder Fehler beim Laden
                        </div>
                    </div>
                    
                    <!-- System-Tab -->
                    <div v-if="adminTab === 'system'">
                        <h3 class="text-lg font-medium mb-4">Systemeinstellungen</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- MOTD Manager -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium mb-2">MOTD-Einstellungen</h4>
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <div class="flex items-center">
                                        <button @click="reloadMotd" class="nscale-btn-secondary text-sm py-1 mr-3">
                                            Neu laden
                                        </button>
                                        <span class="text-sm" v-if="motd.enabled">Aktiviert</span>
                                        <span class="text-sm" v-else>Deaktiviert</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cache Manager -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-medium mb-2">Cache-Verwaltung</h4>
                                <div class="flex space-x-3">
                                    <button @click="clearModelCache" class="nscale-btn-secondary text-sm py-1">
                                        LLM-Cache leeren
                                    </button>
                                    <button @click="clearEmbeddingCache" class="nscale-btn-secondary text-sm py-1">
                                        Embedding-Cache leeren
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logs-Tab -->
                    <div v-if="adminTab === 'logs'">
                        <h3 class="text-lg font-medium mb-4">Logs & Statistiken</h3>
                        
                        <div class="mb-6">
                            <h4 class="font-medium mb-2">Dokumentstatistiken</h4>
                            <div v-if="systemStats" class="bg-gray-50 p-4 rounded-lg">
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="text-sm">
                                        <span class="text-gray-500">Dokumente:</span>
                                        <span class="font-medium">{{ systemStats.document_count }}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="text-gray-500">Chunks:</span>
                                        <span class="font-medium">{{ systemStats.chunk_count }}</span>
                                    </div>
                                </div>
                                
                                <h5 class="text-sm font-medium mb-2">Dokumentdetails:</h5>
                                <div v-for="(docStats, filename) in systemStats.documents" :key="filename" class="text-sm mb-2 p-2 bg-white rounded">
                                    <div class="font-medium">{{ filename }}</div>
                                    <div class="text-xs text-gray-500 flex space-x-3">
                                        <span>{{ (docStats.size / 1024).toFixed(2) }} KB</span>
                                        <span>{{ docStats.chunks }} Chunks</span>
                                        <span>{{ docStats.total_tokens }} Token</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-gray-500">
                                Keine Statistiken verfügbar
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="px-4 py-3 bg-gray-50 text-right sm:px-6 border-t border-gray-200">
                    <button @click="showAdminPanel = false" class="nscale-btn-primary">
                        Schließen
                    </button>
                </div>
            </div>
        </div>
            <!-- Main Content -->
            <div class="flex flex-1 overflow-hidden container mx-auto my-4">
                <!-- Sessions Sidebar -->
                <aside class="nscale-sidebar w-80 p-4 rounded-l-lg overflow-y-auto">
                    <h2 class="text-lg font-medium mb-6 text-gray-700">Unterhaltungen</h2>
                    <ul class="space-y-2">
                        <li v-for="session in sessions" :key="session.id" 
                            @click="loadSession(session.id)"
                            :class="['nscale-session-item cursor-pointer', 
                            currentSessionId === session.id ? 'active' : '']">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    <span class="truncate">{{ session.title }}</span>
                                </div>
                                <button @click.stop="deleteSession(session.id)" class="text-gray-400 hover:text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </li>
                    </ul>
                </aside>
                
                <!-- Chat Area -->
                <main class="nscale-card flex-1 flex flex-col bg-white overflow-hidden rounded-r-lg ml-4">
                    <div v-if="!currentSessionId" class="flex h-full items-center justify-center text-gray-400 p-8">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <h3 class="text-lg font-medium mb-2">Keine Unterhaltung ausgewählt</h3>
                            <p class="text-sm text-gray-500 mb-4">Wählen Sie eine Unterhaltung aus der Seitenleiste oder starten Sie eine neue.</p>
                            <button @click="startNewSession" class="nscale-btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Neue Unterhaltung starten
                            </button>
                        </div>
                    </div>
                    
                    <div v-else class="chat-container">
                        <!-- Chat Messages -->
                        <div class="message-container" ref="chatMessages">
                            <div v-for="(message, index) in messages" :key="index" class="mb-6">
                              <!-- Systemnachricht -->
                              <div v-if="message.is_system" class="nscale-message-system">
                                <div v-html="formatMessage(message.message)" class="prose"></div>
                              </div>
                              <!-- Normale Nutzer- oder Assistentennachricht -->
                              <div v-else :class="[message.is_user ? 'nscale-message-user' : 'nscale-message-assistant']">
                                <div v-html="formatMessage(message.message)" class="prose"></div>
                                
                                <!-- Feedback-Buttons nur für Assistenten-Nachrichten -->
                                <div v-if="!message.is_user" class="feedback-buttons">
                                  <span v-if="message.feedback_comment" class="feedback-comment">{{ message.feedback_comment }}</span>
                                  <button 
                                    @click="submitFeedback(message.id, message.session_id || currentSessionId, true)" 
                                    :class="['feedback-button', { 'selected': message.feedback_positive === true }]"
                                    title="Hilfreich">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                    </svg>
                                  </button>
                                  <button 
                                    @click="submitFeedback(message.id, message.session_id || currentSessionId, false)" 
                                    :class="['feedback-button', { 'selected negative': message.feedback_positive === false }]"
                                    title="Nicht hilfreich">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2" />
                                    </svg>
                                  </button>
                                  <button 
                                    v-if="message.feedback_positive === false" 
                                    @click="showFeedbackCommentDialog(message)" 
                                    class="feedback-button"
                                    title="Kommentar hinzufügen">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                    </svg>
                                  </button>
                                </div>
                              </div>
                            </div>
                            <div v-if="isLoading" class="flex justify-center p-4">
                              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                            </div>
                          </div>
                          
                          <!-- Feedback-Kommentar-Dialog -->
                          <div v-if="showFeedbackDialog" class="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center">
                            <div class="bg-white rounded-lg w-96 shadow-xl overflow-hidden">
                              <div class="p-4 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-medium">Feedback geben</h3>
                                <button @click="showFeedbackDialog = false" class="text-gray-500 hover:text-gray-700">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </div>
                              <div class="p-5">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                  Warum war diese Antwort nicht hilfreich?
                                </label>
                                <textarea 
                                  v-model="feedbackComment" 
                                  class="nscale-input w-full h-24"
                                  placeholder="Bitte beschreiben Sie, was an der Antwort verbessert werden könnte..."></textarea>
                                <div class="mt-4 flex justify-end">
                                  <button @click="showFeedbackDialog = false" class="text-gray-500 mr-3">
                                    Abbrechen
                                  </button>
                                  <button @click="submitFeedbackComment" class="nscale-btn-primary">
                                    Senden
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        
                        <!-- Input Area -->
                        <div class="input-container bg-white">
                            <form @submit.prevent="sendQuestionStream" class="flex space-x-2">
                                <input v-model="question" class="nscale-input flex-1" 
                                    placeholder="Stellen Sie Ihre Frage zur nscale DMS-Software..." 
                                    :disabled="!currentSessionId || isLoading" />
                                <button type="submit" class="nscale-btn-primary"
                                    :disabled="!currentSessionId || !question || isLoading">
                                    <span v-if="isLoading">
                                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Wird gesendet...
                                    </span>
                                    <span v-else>Senden</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <script>
        const { createApp, ref, onMounted, watch, nextTick } = Vue;
        
        createApp({
            setup() {
                // Authentication state
                const token = ref(localStorage.getItem('token') || '');
                const email = ref('');
                const password = ref('');
                const authMode = ref('login');
                const loading = ref(false);
                const errorMessage = ref('');
                const successMessage = ref('');
                
                // Chat state
                const sessions = ref([]);
                const currentSessionId = ref(null);
                const messages = ref([]);
                const question = ref('');
                const isLoading = ref(false);
                const chatMessages = ref(null);
                const isStreaming = ref(false);
                const eventSource = ref(null);
                
                const showFeedbackDialog = ref(false);
                const feedbackComment = ref('');
                const feedbackMessage = ref(null);
                const motd = ref({
                    enabled: false,
                    content: '',
                    format: 'text',
                    style: {},
                    display: {}
                });
                const motdDismissed = ref(false);

                // Setup axios with auth header
                const setupAxios = () => {
                    axios.defaults.headers.common['Authorization'] = token.value ? `Bearer ${token.value}` : '';
                };
                
                const loadMotd = async () => {
                    try {
                        const response = await axios.get('/api/motd');
                        motd.value = response.data;
                        // Prüfe auf gespeicherten Dismissed-Status
                        const savedDismissed = localStorage.getItem('motdDismissed');
                        if (savedDismissed) {
                            motdDismissed.value = true;
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der MOTD:', error);
                    }
                };
                const addSystemMotd = () => {
                    // Fügt die MOTD als System-Nachricht zum Chat hinzu, wenn aktiviert
                    if (motd.value.enabled && motd.value.display.showInChat && 
                        messages.value.length === 0 && currentSessionId.value) {
                        messages.value.push({
                            is_user: false,
                            is_system: true, // Spezielle Markierung für Systemnachrichten
                            message: motd.value.content,
                            timestamp: Date.now() / 1000
                        });
                        
                        // Scroll nach unten, nachdem die Nachricht hinzugefügt wurde
                        nextTick(() => {
                            scrollToBottom();
                        });
                    }
                };

                const dismissMotd = () => {
                    motdDismissed.value = true;
                    localStorage.setItem('motdDismissed', 'true');
                };
                // Funktion zum Senden von Feedback
                const submitFeedback = async (messageId, sessionId, isPositive) => {
                try {
                    const response = await axios.post('/api/feedback', {
                    message_id: messageId,
                    session_id: sessionId,
                    is_positive: isPositive,
                    comment: null
                    });
                    
                    // Aktualisiere den Feedback-Status in der Nachricht
                    const messageIndex = messages.value.findIndex(m => m.id === messageId);
                    if (messageIndex >= 0) {
                    messages.value[messageIndex].feedback_positive = isPositive;
                    
                    // Wenn negatives Feedback gegeben wird, zeige Dialog für Kommentar an
                    if (!isPositive && !messages.value[messageIndex].feedback_comment) {
                        showFeedbackCommentDialog(messages.value[messageIndex]);
                    }
                    }
                    
                    console.log('Feedback erfolgreich gesendet');
                } catch (error) {
                    console.error('Fehler beim Senden des Feedbacks:', error);
                }
                };
                // Öffnet den Dialog für Feedback-Kommentare
                const showFeedbackCommentDialog = (message) => {
                feedbackMessage.value = message;
                feedbackComment.value = message.feedback_comment || '';
                showFeedbackDialog.value = true;
                };

                // Sendet den Feedback-Kommentar
                const submitFeedbackComment = async () => {
                    if (!feedbackMessage.value) return;
                    
                    try {
                        const response = await axios.post('/api/feedback', {
                        message_id: feedbackMessage.value.id,
                        session_id: feedbackMessage.value.session_id || currentSessionId.value,
                        is_positive: false,
                        comment: feedbackComment.value
                        });
                        
                        // Aktualisiere den Kommentar in der Nachricht
                        const messageIndex = messages.value.findIndex(m => m.id === feedbackMessage.value.id);
                        if (messageIndex >= 0) {
                        messages.value[messageIndex].feedback_comment = feedbackComment.value;
                        }
                        
                        console.log('Feedback-Kommentar erfolgreich gesendet');
                        showFeedbackDialog.value = false;
                    } catch (error) {
                        console.error('Fehler beim Senden des Feedback-Kommentars:', error);
                    }
                    };

                // Funktion zum Laden des Feedbacks für Nachrichten
                const loadMessageFeedback = async (messageId) => {
                try {
                    const response = await axios.get(`/api/feedback/message/${messageId}`);
                    
                    if (response.data.feedback) {
                    // Aktualisiere den Feedback-Status in der Nachricht
                    const messageIndex = messages.value.findIndex(m => m.id === messageId);
                    if (messageIndex >= 0) {
                        messages.value[messageIndex].feedback_positive = response.data.feedback.is_positive;
                        messages.value[messageIndex].feedback_comment = response.data.feedback.comment;
                    }
                    }
                } catch (error) {
                    console.error('Fehler beim Laden des Feedbacks:', error);
                }
                };

                // Erweitere die loadSession-Funktion, um Feedback zu laden
                const loadSession = async (sessionId) => {
                try {
                    isLoading.value = true;
                    const response = await axios.get(`/api/session/${sessionId}`);
                    currentSessionId.value = sessionId;
                    messages.value = response.data.messages;
                    
                    // MOTD als System-Nachricht hinzufügen, wenn keine Nachrichten vorhanden
                    if (messages.value.length === 0) {
                    addSystemMotd();
                    }
                    
                    // Feedback für jede Assistenten-Nachricht laden
                    for (const message of messages.value) {
                    if (!message.is_user && message.id) {
                        await loadMessageFeedback(message.id);
                    }
                    }
                    
                    // Scroll to bottom after messages load
                    await nextTick();
                    scrollToBottom();
                } catch (error) {
                    console.error('Error loading session:', error);
                } finally {
                    isLoading.value = false;
                }
                };
                const userRole = ref('user');
                const showAdminPanel = ref(false);
                const adminTab = ref('users');
                const adminUsers = ref([]);
                const newUser = ref({
                    email: '',
                    password: '',
                    role: 'user'
                });
                const systemStats = ref(null);

                // Funktion zum Laden der Benutzerrolle
                const loadUserRole = async () => {
                    try {
                        if (token.value) {
                            const response = await axios.get('/api/user/role');
                            userRole.value = response.data.role;
                            console.log(`Benutzerrolle geladen: ${userRole.value}`);
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Benutzerrolle:', error);
                    }
                };

                // Funktion zum Laden der Benutzerliste (nur für Admins)
                const loadUsers = async () => {
                    try {
                        if (userRole.value === 'admin') {
                            const response = await axios.get('/api/admin/users');
                            adminUsers.value = response.data.users;
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Benutzerliste:', error);
                    }
                };

                // Benutzer erstellen (Admin)
                const createUser = async () => {
                    try {
                        if (!newUser.value.email || !newUser.value.password) {
                            alert("Bitte E-Mail und Passwort angeben.");
                            return;
                        }
                        
                        await axios.post('/api/admin/users', newUser.value);
                        alert(`Benutzer ${newUser.value.email} erfolgreich erstellt.`);
                        
                        // Formular zurücksetzen und Liste aktualisieren
                        newUser.value = { email: '', password: '', role: 'user' };
                        await loadUsers();
                    } catch (error) {
                        console.error('Fehler beim Erstellen des Benutzers:', error);
                        alert(`Fehler: ${error.response?.data?.detail || 'Unbekannter Fehler'}`);
                    }
                };

                // Benutzerrolle ändern (Admin)
                const updateUserRole = async (userId, newRole) => {
                    try {
                        await axios.put('/api/admin/users/role', {
                            user_id: userId,
                            new_role: newRole
                        });
                        
                        console.log(`Rolle für Benutzer ID ${userId} auf ${newRole} aktualisiert`);
                    } catch (error) {
                        console.error('Fehler beim Aktualisieren der Benutzerrolle:', error);
                        alert(`Fehler: ${error.response?.data?.detail || 'Unbekannter Fehler'}`);
                        // Liste neu laden, um ursprüngliche Werte wiederherzustellen
                        await loadUsers();
                    }
                };

                // Benutzer löschen (Admin) - derzeit nicht implementiert
                const deleteUser = async (userId) => {
                    alert("Diese Funktion ist noch nicht implementiert.");
                };

                // MOTD neu laden (Admin)
                const reloadMotd = async () => {
                    try {
                        await axios.post('/api/admin/reload-motd');
                        await loadMotd();
                        alert("MOTD erfolgreich neu geladen.");
                    } catch (error) {
                        console.error('Fehler beim Neuladen der MOTD:', error);
                        alert(`Fehler: ${error.response?.data?.detail || 'Unbekannter Fehler'}`);
                    }
                };

                // Cache leeren (Admin)
                const clearModelCache = async () => {
                    try {
                        await axios.post('/api/admin/clear-cache');
                        alert("LLM-Cache erfolgreich geleert.");
                    } catch (error) {
                        console.error('Fehler beim Leeren des LLM-Cache:', error);
                        alert(`Fehler: ${error.response?.data?.detail || 'Unbekannter Fehler'}`);
                    }
                };

                const clearEmbeddingCache = async () => {
                    try {
                        // Dieser Endpunkt muss noch erstellt werden
                        await axios.post('/api/admin/clear-embedding-cache');
                        alert("Embedding-Cache erfolgreich geleert.");
                    } catch (error) {
                        console.error('Fehler beim Leeren des Embedding-Cache:', error);
                        alert(`Fehler: ${error.response?.data?.detail || 'Unbekannter Fehler'}`);
                    }
                };

                // Systemstatistiken laden (Admin)
                const loadSystemStats = async () => {
                    try {
                        if (userRole.value === 'admin') {
                            const response = await axios.get('/api/admin/stats');
                            systemStats.value = response.data.stats;
                        }
                    } catch (error) {
                        console.error('Fehler beim Laden der Systemstatistiken:', error);
                    }
                };

                // Im onMounted-Hook müssen wir die Benutzerrolle laden
                // Ändere den onMounted-Hook wie folgt:
                onMounted(() => {
                    setupAxios();
                    
                    // MOTD-Konfiguration laden
                    loadMotd();
                    
                    if (token.value) {
                        loadSessions();
                        // Benutzerrolle laden
                        loadUserRole();
                    }
                    
                    // Clear messages when auth state changes
                    watch(token, (newValue) => {
                        if (!newValue) {
                            messages.value = [];
                            currentSessionId.value = null;
                        } else {
                            // Wenn sich der Token ändert (z.B. nach Login), Benutzerrolle laden
                            loadUserRole();
                        }
                    });
                    
                    // Clear error message when auth mode changes
                    watch(authMode, () => {
                        errorMessage.value = '';
                        successMessage.value = '';
                    });
                    
                    // EventSource bereinigen, wenn die Komponente zerstört wird
                    window.addEventListener('beforeunload', () => {
                        if (eventSource.value) {
                            eventSource.value.close();
                        }
                    });
                });

                // Watch für Admin-Panel: Lade Daten, wenn das Panel geöffnet wird
                watch(showAdminPanel, (isOpen) => {
                    if (isOpen && userRole.value === 'admin') {
                        loadUsers();
                        loadSystemStats();
                    }
                });

                const cleanupStream = () => {
                    console.log("cleanupStream aufgerufen");
                    
                    // Timer löschen
                    if (streamTimeout) {
                        clearTimeout(streamTimeout);
                        streamTimeout = null;
                    }
                    // tokencount zurücksetzen
                    tokenCount = 0;

                    if (eventSource.value) {
                        try {
                            console.log("Schließe EventSource");
                            // Alle Event-Listener entfernen, um Memory-Leaks zu vermeiden
                            eventSource.value.onmessage = null;
                            eventSource.value.onerror = null;
                            
                            // Alle spezifischen Event-Listener entfernen
                            eventSource.value.removeEventListener('done', () => {});
                            eventSource.value.removeEventListener('open', () => {});
                            
                            // EventSource schließen
                            eventSource.value.close();
                            eventSource.value = null;
                        } catch (e) {
                            console.error("Fehler beim Bereinigen des EventSource:", e);
                        }
                    }
                    isLoading.value = false;
                    isStreaming.value = false;
                };
                
                const testSSEParsing = () => {
                    // Testdaten
                    const testData = [
                        '{"response":" "}',
                        '{"response":"Hallo"}',
                        '{"response":""}',
                        '{"error":"Test error"}'
                    ];
                    
                    console.log("==== SSE PARSER TEST ====");
                    testData.forEach(data => {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`Original: ${data}`);
                            console.log(`'response' in parsed: ${'response' in parsed}`);
                            console.log(`parsed.response: ${parsed.response}`);
                            console.log(`Boolean(parsed.response): ${Boolean(parsed.response)}`);
                            console.log("----");
                        } catch (e) {
                            console.error(`Parsing error for ${data}: ${e}`);
                        }
                    });
                    console.log("========================");
                };

                testSSEParsing();
                
                // Dynamischer Timeout, sobald keine Tokens mehr empfangen werden
                let streamTimeout;

                const resetStreamTimeout = () => {
                    if (streamTimeout) {
                        clearTimeout(streamTimeout);
                    }
                    
                    streamTimeout = setTimeout(() => {
                        if (isStreaming.value) {
                            console.warn(`Stream inaktiv für 30s, bisher ${tokenCount} Tokens empfangen`);
                            cleanupStream();
                        }
                    }, 30000);  // 30 Sekunden Inaktivität
                };
                // Komplette Überarbeitung der Event-Handling-Logik
                const sendQuestionStream = async () => {
                    if (!question.value.trim() || !currentSessionId.value) {
                        console.warn("Leere Frage oder keine Session ausgewählt");
                        return;
                    }

                    try {
                        console.log(`Sende Frage: "${question.value}"`);
                        isLoading.value = true;
                        isStreaming.value = true;

                        // Benutzernachricht sofort hinzufügen
                        messages.value.push({
                            is_user: true,
                            message: question.value,
                            timestamp: Date.now() / 1000
                        });

                        // Platz für Assistentennachricht reservieren
                        const assistantIndex = messages.value.length;
                        messages.value.push({
                            is_user: false,
                            message: '',
                            timestamp: Date.now() / 1000
                        });

                        await nextTick();
                        scrollToBottom();

                        // EventSource erstellen
                        const url = new URL('/api/question/stream', window.location.origin);
                        url.searchParams.append('question', question.value);
                        url.searchParams.append('session_id', currentSessionId.value);

                        // Token als URL-Parameter übergeben für SSE-Authentifizierung
                        const authToken = token.value.replace('Bearer ', '');
                        url.searchParams.append('auth_token', authToken);

                        console.log(`Streaming URL: ${url.toString()}`);

                        // Bestehende EventSource schließen
                        if (eventSource.value) {
                            console.log("Schließe bestehende EventSource");
                            eventSource.value.close();
                            eventSource.value = null;
                        }

                        // Neue EventSource-Verbindung
                        console.log("Erstelle neue EventSource");
                        eventSource.value = new EventSource(url.toString());
                        
                        // Zähler für Debugging
                        tokenCount = 0;

                        eventSource.value.onmessage = (event) => {
                            try {
                                // Beim Empfang jedes Tokens den Timeout zurücksetzen
                                resetStreamTimeout();
                                // KRITISCHE ÄNDERUNG: Der Browser fügt "data: " nicht zum event.data hinzu!
                                // Es ist bereits da, weil es vom Server so gesendet wird
                                if (!event.data || event.data.trim() === '') {
                                    console.log("Leeres Datenevent ignorieren");
                                    return;
                                }
                                
                                console.log(`Rohes Event erhalten: ${event.data}`);
                                
                                // Einfach das event.data direkt verwenden, KEIN data:-Präfix entfernen
                                // Der Fehler ist, dass wir den JSON direkt parsen
                                let jsonData = event.data;
                                // Wenn es wirklich mit "data: " beginnt, entfernen wir dieses Präfix
                                if (jsonData.startsWith('data: ')) {
                                    jsonData = jsonData.substring(6);
                                }
                                
                                // Versuche JSON zu parsen
                                const data = JSON.parse(jsonData);
                                
                                if ('response' in data) {
                                    tokenCount++;
                                    const token = data.response;
                                    console.log(`Token #${tokenCount}: "${token}"`);
                                    
                                    // Token zur Assistenten-Nachricht hinzufügen
                                    messages.value[assistantIndex].message += token;
                                    scrollToBottom();
                                } else if (data.error) {
                                    console.error("Stream-Fehler:", data.error);
                                    messages.value[assistantIndex].message = `Fehler: ${data.error}`;
                                    cleanupStream();
                                }
                            } catch (e) {
                                console.error("JSON-Parsing-Fehler:", e, "Rohdaten:", event.data);
                                // Ignoriere JSON-Fehler für spezielle Event-Typen
                                if (event.data && event.data.includes('event: done')) {
                                    console.log("'done'-Event erkannt, wird separat verarbeitet");
                                }
                            }
                        };

                        // Spezieller Handler für 'done' Events - WICHTIG
                        eventSource.value.addEventListener('done', (event) => {
                            console.log("DONE Event empfangen, Stream beendet");
                            cleanupStream();
                        });

                        // Error-Handler
                        eventSource.value.onerror = (event) => {
                            console.error('SSE-Verbindungsfehler:', event);
                            if (tokenCount === 0) {
                                messages.value[assistantIndex].message = 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.';
                            }
                            cleanupStream();
                        };

                        // Timeout für hängende Verbindungen
                        resetStreamTimeout();

                        // Frage für nächste Eingabe zurücksetzen
                        question.value = '';

                    } catch (error) {
                        console.error('Streaming-Fehler:', error);
                        isLoading.value = false;
                        isStreaming.value = false;
                    }
                };
         
                // Herkömmliche Anfrage (als Fallback)
                const sendQuestion = async () => {
                    if (!question.value.trim() || !currentSessionId.value) {
                        return;
                    }
                    
                    try {
                        isLoading.value = true;
                        
                        // Add user message immediately for better UX
                        messages.value.push({
                            is_user: true,
                            message: question.value,
                            timestamp: Date.now() / 1000
                        });
                        
                        await nextTick();
                        scrollToBottom();
                        
                        const response = await axios.post('/api/question', {
                            question: question.value,
                            session_id: currentSessionId.value
                        });
                        
                        // Add assistant response
                        messages.value.push({
                            is_user: false,
                            message: response.data.answer,
                            timestamp: Date.now() / 1000
                        });
                        
                        // Clear input
                        question.value = '';
                        
                        await nextTick();
                        scrollToBottom();
                    } catch (error) {
                        console.error('Error sending question:', error);
                        
                        // Add error message
                        messages.value.push({
                            is_user: false,
                            message: 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.',
                            timestamp: Date.now() / 1000
                        });
                        
                        await nextTick();
                        scrollToBottom();
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                // Auth functions
                const login = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        
                        const response = await axios.post('/api/auth/login', {
                            email: email.value,
                            password: password.value
                        });
                        
                        token.value = response.data.token;
                        localStorage.setItem('token', token.value);
                        setupAxios();
                        
                        // Clear form
                        email.value = '';
                        password.value = '';
                        
                        // Load sessions
                        loadSessions();
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Anmeldefehler. Bitte versuchen Sie es erneut.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const register = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        
                        await axios.post('/api/auth/register', {
                            email: email.value,
                            password: password.value
                        });
                        
                        // Switch to login after successful registration
                        authMode.value = 'login';
                        successMessage.value = 'Registrierung erfolgreich. Bitte melden Sie sich an.';
                        
                        // Clear form
                        email.value = '';
                        password.value = '';
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Registrierungsfehler. Bitte versuchen Sie es erneut.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const resetPassword = async () => {
                    try {
                        loading.value = true;
                        errorMessage.value = '';
                        successMessage.value = '';
                        
                        const response = await axios.post('/api/auth/reset-password', {
                            email: email.value
                        });
                        
                        successMessage.value = response.data.message;
                        
                        // In a real app, the user would receive an email with the token
                        // For this example, we'll show the token directly
                        if (response.data.token) {
                            successMessage.value += ` Token: ${response.data.token}`;
                        }
                    } catch (error) {
                        errorMessage.value = error.response?.data?.detail || 'Fehler beim Zurücksetzen des Passworts.';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('token');
                    setupAxios();
                    currentSessionId.value = null;
                    sessions.value = [];
                    messages.value = [];
                    
                    // EventSource schließen, falls vorhanden
                    if (eventSource.value) {
                        eventSource.value.close();
                        eventSource.value = null;
                    }
                };
                
            

                const loadSessions = async () => {
                    try {
                        const response = await axios.get('/api/sessions');
                        sessions.value = response.data.sessions;
                    } catch (error) {
                        console.error('Error loading sessions:', error);
                    }
                };
                
                
                const startNewSession = async () => {
                    try {
                        isLoading.value = true;
                        const response = await axios.post('/api/session', {
                            title: "Neue Unterhaltung"
                        });
                        
                        await loadSessions();
                        currentSessionId.value = response.data.session_id;
                        messages.value = [];
                        
                        // MOTD als System-Nachricht hinzufügen
                        addSystemMotd();
                        
                        await nextTick();
                        scrollToBottom();
                    } catch (error) {
                        console.error('Error starting new session:', error);
                    } finally {
                        isLoading.value = false;
                    }
                };
                                
                const deleteSession = async (sessionId) => {
                    if (!confirm('Möchten Sie diese Unterhaltung wirklich löschen?')) {
                        return;
                    }
                    
                    try {
                        await axios.delete(`/api/session/${sessionId}`);
                        
                        if (currentSessionId.value === sessionId) {
                            currentSessionId.value = null;
                            messages.value = [];
                        }
                        
                        await loadSessions();
                    } catch (error) {
                        console.error('Error deleting session:', error);
                    }
                };
                
                const formatMessage = (text) => {
                    return marked.parse(text);
                };
                
                const scrollToBottom = () => {
                    if (chatMessages.value) {
                        chatMessages.value.scrollTop = chatMessages.value.scrollHeight;
                    }
                };
                
                // Initialize
                onMounted(() => {
                    setupAxios();
                    
                    // MOTD-Konfiguration laden
                    loadMotd();
                    
                    if (token.value) {
                        loadSessions();
                    }
                    
                    // Clear messages when auth state changes
                    watch(token, (newValue) => {
                        if (!newValue) {
                            messages.value = [];
                            currentSessionId.value = null;
                        }
                    });
                    
                    // Clear error message when auth mode changes
                    watch(authMode, () => {
                        errorMessage.value = '';
                        successMessage.value = '';
                    });
                    
                    // EventSource bereinigen, wenn die Komponente zerstört wird
                    window.addEventListener('beforeunload', () => {
                        if (eventSource.value) {
                            eventSource.value.close();
                        }
                    });
                });
                
                return {
                    // Auth state
                    token,
                    email,
                    password,
                    authMode,
                    loading,
                    errorMessage,
                    successMessage,
                    
                    // Auth functions
                    login,
                    register,
                    resetPassword,
                    logout,
                    
                    // Chat state
                    sessions,
                    currentSessionId,
                    messages,
                    question,
                    isLoading,
                    chatMessages,
                    isStreaming,
                    
                    // Chat functions
                    sendQuestionStream,
                    sendQuestion,
                    loadSessions,
                    loadSession,
                    startNewSession,
                    deleteSession,
                    formatMessage,
                    scrollToBottom,
                    
                    // Message of the day
                    motd,
                    motdDismissed,
                    loadMotd,
                    dismissMotd,

                    // Rechte- und Rollenkonzept
                    userRole,
                    showAdminPanel,
                    adminTab,
                    adminUsers,
                    newUser,
                    systemStats,
                    loadUserRole,
                    loadUsers,
                    createUser,
                    updateUserRole,
                    deleteUser,
                    reloadMotd,
                    clearModelCache,
                    clearEmbeddingCache,
                    loadSystemStats,
                    showFeedbackDialog,
                    feedbackComment,
                    feedbackMessage,
                    submitFeedback,
                    showFeedbackCommentDialog,
                    submitFeedbackComment,
                    loadMessageFeedback,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>