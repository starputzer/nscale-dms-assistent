<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin API Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .endpoint-test {
            margin: 10px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-success {
            background: #28a745;
            color: white;
        }
        .status-error {
            background: #dc3545;
            color: white;
        }
        .status-pending {
            background: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Admin API Debug Tool</h1>
        
        <div class="test-section info">
            <h2>Auth Status</h2>
            <div id="authStatus">Checking...</div>
            <button onclick="checkAuth()">Check Auth</button>
            <button onclick="performLogin()">Login as Admin</button>
            <button onclick="clearAuth()">Clear Auth</button>
        </div>

        <div class="test-section">
            <h2>API Endpoints Test</h2>
            <div id="endpointTests"></div>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
        </div>

        <div class="test-section">
            <h2>Detailed Logs</h2>
            <div class="log" id="logs"></div>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        const endpoints = [
            { name: 'Users List', path: '/api/v1/admin/users', method: 'GET' },
            { name: 'Users Count', path: '/api/v1/admin/users/count', method: 'GET' },
            { name: 'Users Stats', path: '/api/v1/admin/users/stats', method: 'GET' },
            { name: 'Feedback', path: '/api/v1/admin/feedback', method: 'GET' },
            { name: 'Feedback Stats', path: '/api/v1/admin/feedback/stats', method: 'GET' },
            { name: 'Feedback Negative', path: '/api/v1/admin/feedback/negative', method: 'GET' },
            { name: 'Health Check', path: '/api/v1/health', method: 'GET' },
            { name: 'MOTD', path: '/api/v1/motd', method: 'GET' }
        ];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const typeEmoji = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            logDiv.innerHTML += `[${timestamp}] ${typeEmoji[type]} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('Logs cleared', 'info');
        }

        async function checkAuth() {
            const token = localStorage.getItem('nscale_access_token');
            const user = localStorage.getItem('nscale_user');
            const authDiv = document.getElementById('authStatus');
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    authDiv.innerHTML = `
                        <p><strong>‚úÖ Authenticated</strong></p>
                        <p>User: ${userData.email || 'Unknown'}</p>
                        <p>Role: ${userData.role || 'Unknown'}</p>
                        <p>Token: ${token.substring(0, 20)}...</p>
                    `;
                    authDiv.parentElement.classList.add('success');
                    authDiv.parentElement.classList.remove('error');
                    log('Auth check: User authenticated', 'success');
                } catch (e) {
                    authDiv.innerHTML = '<p>‚ö†Ô∏è Invalid user data in localStorage</p>';
                    log('Auth check: Invalid user data', 'warning');
                }
            } else {
                authDiv.innerHTML = '<p>‚ùå Not authenticated</p>';
                authDiv.parentElement.classList.add('error');
                authDiv.parentElement.classList.remove('success');
                log('Auth check: Not authenticated', 'error');
            }
        }

        async function performLogin() {
            log('Starting login process...', 'info');
            
            try {
                const response = await fetch('/api/v1/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'martin@danglefeet.com',
                        password: '123'
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.access_token) {
                    localStorage.setItem('nscale_access_token', data.access_token);
                    localStorage.setItem('nscale_refresh_token', data.refresh_token || '');
                    localStorage.setItem('nscale_token_expiry', data.expires_at || new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());
                    
                    const userData = {
                        id: data.user_id || 'admin',
                        email: 'martin@danglefeet.com',
                        name: 'Martin Admin',
                        role: 'admin'
                    };
                    localStorage.setItem('nscale_user', JSON.stringify(userData));
                    
                    log('Login successful!', 'success');
                    await checkAuth();
                } else {
                    log(`Login failed: ${response.status} - ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        }

        function clearAuth() {
            localStorage.removeItem('nscale_access_token');
            localStorage.removeItem('nscale_refresh_token');
            localStorage.removeItem('nscale_token_expiry');
            localStorage.removeItem('nscale_user');
            log('Auth cleared', 'info');
            checkAuth();
        }

        async function testEndpoint(endpoint) {
            const token = localStorage.getItem('nscale_access_token');
            const startTime = Date.now();
            
            log(`Testing ${endpoint.name} (${endpoint.method} ${endpoint.path})...`, 'info');
            
            try {
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(endpoint.path, {
                    method: endpoint.method,
                    headers: headers
                });
                
                const responseTime = Date.now() - startTime;
                const contentType = response.headers.get('content-type');
                let data = null;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }
                
                if (response.ok) {
                    log(`‚úÖ ${endpoint.name}: ${response.status} OK (${responseTime}ms)`, 'success');
                    log(`Response: ${JSON.stringify(data, null, 2)}`, 'info');
                    return { endpoint, status: 'success', statusCode: response.status, data, responseTime };
                } else {
                    log(`‚ùå ${endpoint.name}: ${response.status} ${response.statusText} (${responseTime}ms)`, 'error');
                    log(`Response: ${JSON.stringify(data, null, 2)}`, 'error');
                    return { endpoint, status: 'error', statusCode: response.status, data, responseTime };
                }
            } catch (error) {
                const responseTime = Date.now() - startTime;
                log(`‚ùå ${endpoint.name}: Network error - ${error.message} (${responseTime}ms)`, 'error');
                return { endpoint, status: 'error', error: error.message, responseTime };
            }
        }

        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('endpointTests');
            resultsDiv.innerHTML = '<p>Testing all endpoints...</p>';
            
            const results = [];
            
            for (const endpoint of endpoints) {
                const result = await testEndpoint(endpoint);
                results.push(result);
                
                // Update UI with result
                const resultHtml = `
                    <div class="endpoint-test">
                        <span>${endpoint.name}</span>
                        <span class="status-badge status-${result.status === 'success' ? 'success' : 'error'}">
                            ${result.statusCode || 'ERROR'} - ${result.responseTime}ms
                        </span>
                    </div>
                `;
                
                if (resultsDiv.innerHTML.includes('Testing all endpoints...')) {
                    resultsDiv.innerHTML = resultHtml;
                } else {
                    resultsDiv.innerHTML += resultHtml;
                }
            }
            
            // Summary
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            
            resultsDiv.innerHTML += `
                <div style="margin-top: 20px; font-weight: bold;">
                    Summary: ${successCount} successful, ${errorCount} failed
                </div>
            `;
            
            log(`Test complete: ${successCount}/${endpoints.length} endpoints working`, 
                successCount === endpoints.length ? 'success' : 'warning');
        }

        // Initial check
        window.onload = () => {
            checkAuth();
            log('Admin API Debug Tool loaded', 'info');
            log('Click "Test All Endpoints" to start testing', 'info');
        };
    </script>
</body>
</html>