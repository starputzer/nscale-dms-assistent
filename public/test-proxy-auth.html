<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Authorization Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .error {
            border-left: 4px solid #dc3545;
        }
        .warning {
            border-left: 4px solid #ffc107;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .logs {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            margin-top: 20px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Vite Proxy Authorization Header Test</h1>
        
        <div class="test-section">
            <h2>1. Setup</h2>
            <label>
                Backend URL (Direct):
                <input type="text" id="backendUrl" value="http://localhost:8000" />
            </label>
            <label>
                Frontend URL (Proxy):
                <input type="text" id="frontendUrl" value="http://localhost:3000" />
            </label>
            <label>
                JWT Token:
                <input type="text" id="jwtToken" placeholder="Enter your JWT token or login first" />
            </label>
            <button onclick="login()">Login to Get Token</button>
            <button onclick="getStoredToken()">Get Token from LocalStorage</button>
            <div id="setupResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Direct Backend Test</h2>
            <button onclick="testDirectBackend()">Test Direct API Call (Port 8000)</button>
            <div id="directResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. Proxy Test</h2>
            <button onclick="testProxy()">Test Through Vite Proxy (Port 3000)</button>
            <div id="proxyResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. Header Variations Test</h2>
            <button onclick="testHeaderVariations()">Test Different Header Formats</button>
            <div id="variationsResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. Advanced Tests</h2>
            <button onclick="testWithAxios()">Test with Axios</button>
            <button onclick="testWithFetchCredentials()">Test with Credentials</button>
            <button onclick="testStreamingEndpoint()">Test Streaming</button>
            <div id="advancedResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>Console Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const log = (message, type = 'info') => {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';
            logsDiv.innerHTML += `${timestamp} ${prefix} ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        };

        const clearLogs = () => {
            document.getElementById('logs').innerHTML = '';
        };

        const showResult = (elementId, content, type = 'info') => {
            const element = document.getElementById(elementId);
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            element.className = `result ${type}`;
        };

        const getStoredToken = () => {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('jwtToken').value = token;
                showResult('setupResult', `Token found in localStorage: ${token.substring(0, 50)}...`, 'success');
                log('Retrieved token from localStorage', 'success');
            } else {
                showResult('setupResult', 'No token found in localStorage', 'warning');
                log('No token in localStorage', 'error');
            }
        };

        const login = async () => {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                log('Attempting login...');
                
                const response = await fetch(`${backendUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'martin@danglefeet.com',
                        password: '123'
                    })
                });

                const data = await response.json();
                log(`Login response: ${response.status}`);
                
                if (data.access_token) {
                    document.getElementById('jwtToken').value = data.access_token;
                    localStorage.setItem('token', data.access_token);
                    showResult('setupResult', `Login successful! Token: ${data.access_token.substring(0, 50)}...`, 'success');
                    log('Login successful, token stored', 'success');
                } else {
                    showResult('setupResult', `Login failed: ${JSON.stringify(data)}`, 'error');
                    log('Login failed: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                showResult('setupResult', `Login error: ${error.message}`, 'error');
                log('Login error: ' + error.message, 'error');
            }
        };

        const testDirectBackend = async () => {
            try {
                const backendUrl = document.getElementById('backendUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                if (!token) {
                    showResult('directResult', 'Please enter a JWT token first', 'error');
                    return;
                }

                log('Testing direct backend call...');
                const response = await fetch(`${backendUrl}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = responseText;
                }

                log(`Direct backend response: ${response.status}`);
                showResult('directResult', 
                    `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('directResult', `Error: ${error.message}`, 'error');
                log('Direct backend error: ' + error.message, 'error');
            }
        };

        const testProxy = async () => {
            try {
                const frontendUrl = document.getElementById('frontendUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                if (!token) {
                    showResult('proxyResult', 'Please enter a JWT token first', 'error');
                    return;
                }

                log('Testing proxy call...');
                const response = await fetch(`${frontendUrl}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = responseText;
                }

                log(`Proxy response: ${response.status}`);
                showResult('proxyResult', 
                    `Status: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('proxyResult', `Error: ${error.message}`, 'error');
                log('Proxy error: ' + error.message, 'error');
            }
        };

        const testHeaderVariations = async () => {
            const frontendUrl = document.getElementById('frontendUrl').value;
            const token = document.getElementById('jwtToken').value;
            
            if (!token) {
                showResult('variationsResult', 'Please enter a JWT token first', 'error');
                return;
            }

            const variations = [
                { name: 'Standard Authorization', headers: { 'Authorization': `Bearer ${token}` } },
                { name: 'Lowercase authorization', headers: { 'authorization': `Bearer ${token}` } },
                { name: 'UPPERCASE AUTHORIZATION', headers: { 'AUTHORIZATION': `Bearer ${token}` } },
                { name: 'Bearer header', headers: { 'Bearer': token } },
                { name: 'X-Authorization', headers: { 'X-Authorization': `Bearer ${token}` } },
            ];

            let results = [];
            for (const variation of variations) {
                log(`Testing ${variation.name}...`);
                try {
                    const response = await fetch(`${frontendUrl}/api/admin/users`, {
                        headers: {
                            ...variation.headers,
                            'Content-Type': 'application/json'
                        }
                    });
                    results.push(`${variation.name}: ${response.status} ${response.statusText}`);
                    log(`${variation.name}: ${response.status}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    results.push(`${variation.name}: ERROR - ${error.message}`);
                    log(`${variation.name}: ERROR`, 'error');
                }
            }

            showResult('variationsResult', results.join('\n'), 'info');
        };

        const testWithAxios = async () => {
            try {
                const frontendUrl = document.getElementById('frontendUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                if (!token) {
                    showResult('advancedResult', 'Please enter a JWT token first', 'error');
                    return;
                }

                log('Testing with Axios...');
                const response = await axios.get(`${frontendUrl}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                log(`Axios response: ${response.status}`, 'success');
                showResult('advancedResult', 
                    `Axios Test - Status: ${response.status}\nData: ${JSON.stringify(response.data, null, 2)}`,
                    'success'
                );
            } catch (error) {
                const errorData = error.response ? error.response.data : error.message;
                showResult('advancedResult', `Axios Error: ${JSON.stringify(errorData)}`, 'error');
                log('Axios error: ' + error.message, 'error');
            }
        };

        const testWithFetchCredentials = async () => {
            try {
                const frontendUrl = document.getElementById('frontendUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                if (!token) {
                    showResult('advancedResult', 'Please enter a JWT token first', 'error');
                    return;
                }

                log('Testing with credentials: include...');
                const response = await fetch(`${frontendUrl}/api/admin/users`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                log(`Credentials test response: ${response.status}`);
                showResult('advancedResult', 
                    `Credentials Test - Status: ${response.status}\nData: ${JSON.stringify(data, null, 2)}`,
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult('advancedResult', `Credentials Error: ${error.message}`, 'error');
                log('Credentials test error: ' + error.message, 'error');
            }
        };

        const testStreamingEndpoint = async () => {
            try {
                const frontendUrl = document.getElementById('frontendUrl').value;
                const token = document.getElementById('jwtToken').value;
                
                if (!token) {
                    showResult('advancedResult', 'Please enter a JWT token first', 'error');
                    return;
                }

                log('Testing streaming endpoint...');
                const response = await fetch(`${frontendUrl}/api/chat/stream`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({
                        message: 'Test message',
                        session_id: 'test-session'
                    })
                });

                log(`Streaming test response: ${response.status}`);
                if (response.ok && response.headers.get('content-type')?.includes('event-stream')) {
                    showResult('advancedResult', 
                        `Streaming Test - Status: ${response.status}\nContent-Type: ${response.headers.get('content-type')}`,
                        'success'
                    );
                } else {
                    const text = await response.text();
                    showResult('advancedResult', 
                        `Streaming Test - Status: ${response.status}\nResponse: ${text}`,
                        'error'
                    );
                }
            } catch (error) {
                showResult('advancedResult', `Streaming Error: ${error.message}`, 'error');
                log('Streaming test error: ' + error.message, 'error');
            }
        };

        // Initialize
        window.onload = () => {
            getStoredToken();
            log('Test page loaded. Make sure both backend (port 8000) and frontend (port 3000) are running.', 'info');
            log('Check the browser DevTools Network tab to see the actual headers being sent.', 'info');
            log('Also check the Vite dev server console for proxy logs.', 'info');
        };
    </script>
</body>
</html>