<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nscale DMS Assistent - Vue 3 SFC Edition</title>
    
    <!-- Externe CDN-Abhängigkeiten - mit Cache-Busting-Parameter für zuverlässiges Laden -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css?v=20250511" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css?v=20250511">
    
    <!-- Vue und erforderliche Abhängigkeiten - Reihenfolge ist wichtig! -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vueuse/shared@9.13.0/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vueuse/core@9.13.0/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi@0.13.11/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.0.33/dist/pinia.iife.js"></script>
    
    <!-- Weitere Hilfsbibliotheken -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- CSS direkt einbinden mit Cache-Busting - Hinweis: keine type="module" bei link-Tags -->
    <link rel="stylesheet" href="/css/main.css?v=20250511">
    <link rel="stylesheet" href="/css/themes.css?v=20250511">
    <link rel="stylesheet" href="/css/improved-ui.css?v=20250511">
    <link rel="stylesheet" href="/css/admin.css?v=20250511">
    <link rel="stylesheet" href="/css/feedback.css?v=20250511">
    <link rel="stylesheet" href="/css/message-actions.css?v=20250511">
    <link rel="stylesheet" href="/css/settings.css?v=20250511">
    <link rel="stylesheet" href="/css/source-references.css?v=20250511">
    
    <!-- Definiere Standardwerte für Feature-Toggles im localStorage -->
    <script>
        // Stelle sicher, dass Feature-Toggles aktiviert sind
        localStorage.setItem('useVueComponents', 'true');
        localStorage.setItem('useVueSfcComponents', 'true');
        localStorage.setItem('useVueDocConverter', 'true');
        localStorage.setItem('useCompleteSfcChat', 'true');
        localStorage.setItem('useCompleteSfcAdmin', 'true');
        localStorage.setItem('useSfcUIComponents', 'true');
    </script>
    
    <!-- Vereinfachte App-Initialisierung - ohne ESM-Imports -->
    <script>
        // Stelle sicher, dass der DOM vollständig geladen ist
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM geladen - Starte vereinfachte App-Initialisierung...');

            // Vue global verwenden (wird über CDN geladen)
            const { createApp } = window.Vue;

            // Warte kurz, um sicherzustellen, dass alles geladen ist
            setTimeout(() => {
                try {
                    // Prüfe, ob app-fallback angezeigt werden muss
                    const appFallback = document.getElementById('app-fallback');
                    if (appFallback) {
                        // Verstecke den Fallback beim erfolgreichen Laden der App
                        const hideAppFallback = () => {
                            appFallback.style.display = 'none';
                        };

                        // Einfache App ohne Module erstellen
                        const simpleApp = createApp({
                            template: `
                                <div class="p-8 max-w-4xl mx-auto bg-white shadow-lg rounded-lg">
                                    <h1 class="text-2xl font-bold mb-4 text-indigo-700">nscale DMS Assistent (Fallback)</h1>
                                    <p class="mb-4">Dies ist eine einfache Fallback-Ansicht für den nscale DMS Assistenten.</p>
                                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                                        <p class="text-yellow-800 font-medium">Hinweis</p>
                                        <p class="text-yellow-700">Die SFC-App konnte nicht vollständig geladen werden. Ihre Komponenten in src/ wurden möglicherweise nicht gefunden.</p>
                                    </div>
                                    <div class="mt-4 space-y-2">
                                        <button @click="login" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                                            Admin Login (/api/auth/login)
                                        </button>
                                        <button @click="reload" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                            Seite neu laden
                                        </button>
                                    </div>
                                </div>
                            `,
                            methods: {
                                login() {
                                    if (typeof window.devLogin === 'function') {
                                        window.devLogin('martin@danglefeet.com', '123');
                                    } else {
                                        alert('Login-Funktion nicht verfügbar');
                                    }
                                },
                                reload() {
                                    window.location.reload();
                                }
                            },
                            mounted() {
                                console.log('Einfache Fallback-App wurde erfolgreich gemountet');
                                hideAppFallback();
                            }
                        });

                        // App am Element mounten
                        simpleApp.mount('#app');
                    }
                } catch (error) {
                    console.error('Kritischer Fehler bei der vereinfachten App-Initialisierung:', error);
                    // Versuche, den Fallback sichtbar zu lassen
                    document.getElementById('dev-login-form').style.display = 'block';
                }
            }, 500);
        });
    </script>

    <!-- Hauptmodul für Legacy-Funktionalität -->
    <script type="module" src="/js/main.js?v=20250511"></script>
    
    <!-- Login-Helfer -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Einfachen Login-Helfer für Entwicklung hinzufügen
            window.devLogin = function(email, password) {
                console.log(`Versuche Login mit ${email}...`);
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                })
                .then(response => {
                    console.log('Login-Antwort erhalten:', response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('userRole', data.role || 'user');
                        location.reload();
                    } else {
                        console.error('Login fehlgeschlagen:', data.message || 'Unbekannter Fehler');
                    }
                })
                .catch(error => {
                    console.error('Login fehlgeschlagen:', error);
                });
            };
            
            // Automatischen Admin-Login vorbereiten
            console.log('Admin-Login verfügbar. Rufe window.devLogin("martin@danglefeet.com", "123") auf, um dich anzumelden.');
        });
    </script>
    
    <style>
        /* Entwicklungsmodus-Styling deaktiviert */
        
        /* Anmeldeformular für direkten Zugriff */
        .dev-login-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 9999;
            width: 320px;
        }
        
        .dev-login-form h3 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .dev-login-form .form-group {
            margin-bottom: 15px;
        }
        
        .dev-login-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .dev-login-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .dev-login-form button {
            width: 100%;
            padding: 10px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .dev-login-form button:hover {
            background: #4338ca;
        }
        
        .dev-login-form .login-message {
            font-size: 14px;
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .dev-login-form .error {
            background: #fee2e2;
            color: #b91c1c;
        }
        
        .dev-login-form .success {
            background: #dcfce7;
            color: #166534;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app" class="h-screen flex flex-col">
        <!-- Fallback-Inhalt, der angezeigt wird, wenn Vue nicht geladen wird -->
        <div id="app-fallback" class="p-4 max-w-4xl mx-auto bg-white shadow-lg rounded-lg my-8">
            <h1 class="text-2xl font-bold mb-4 text-indigo-700">nscale DMS Assistent</h1>
            <p class="mb-4">Lade Vue-Komponenten...</p>
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                <p class="text-blue-800 font-medium">Initialisiere Anwendung</p>
                <p class="text-blue-700">Bitte warten Sie einen Moment, während die Anwendung geladen wird.</p>
            </div>
            <div class="mt-4">
                <button onclick="window.devLogin('martin@danglefeet.com', '123')"
                        class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Admin Login (/api/auth/login)
                </button>
            </div>
        </div>
    </div>


    <!-- Entwickler-Login (außerhalb des Vue Mount-Punkts) -->
    <div id="dev-login-form" class="dev-login-form" style="display: none;">
        <h3>Entwickler-Login</h3>
        <div class="form-group">
            <label for="dev-email">E-Mail</label>
            <input type="email" id="dev-email" value="martin@danglefeet.com">
        </div>
        <div class="form-group">
            <label for="dev-password">Passwort</label>
            <input type="password" id="dev-password" value="123">
        </div>
        <button id="dev-login-button">Anmelden</button>
        <div id="login-message" class="login-message" style="display: none;"></div>
    </div>
    
    <!-- Einfache Entwickleransicht initialisieren - ohne automatische Reparaturen -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 nscale DMS Assistent (Vue 3 SFC Edition) - Entwicklungsmodus');
            
            // Nach 5 Sekunden prüfen, ob der Fallback noch angezeigt wird
            setTimeout(() => {
                const appFallback = document.getElementById('app-fallback');
                if (appFallback && appFallback.style.display !== 'none') {
                    console.warn('Vue-App wurde nicht erfolgreich initialisiert. Zeige Entwickler-Login an.');
                    document.getElementById('dev-login-form').style.display = 'block';
                }
            }, 5000);
            
            // Entwickler-Login-Funktionalität
            const loginButton = document.getElementById('dev-login-button');
            loginButton.addEventListener('click', () => {
                const email = document.getElementById('dev-email').value;
                const password = document.getElementById('dev-password').value;
                const messageElem = document.getElementById('login-message');
                
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                })
                .then(response => {
                    console.log('Login-Antwort erhalten:', response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.token) {
                        messageElem.textContent = 'Login erfolgreich! Lade Seite neu...';
                        messageElem.className = 'login-message success';
                        messageElem.style.display = 'block';
                        
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('userRole', data.role || 'user');
                        
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        messageElem.textContent = data.message || 'Login fehlgeschlagen';
                        messageElem.className = 'login-message error';
                        messageElem.style.display = 'block';
                    }
                })
                .catch(error => {
                    messageElem.textContent = 'Fehler: ' + error.message;
                    messageElem.className = 'login-message error';
                    messageElem.style.display = 'block';
                });
            });
            
            // Tastenkombination für Entwickler-Login
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.shiftKey && e.key === 'D') {
                    const loginForm = document.getElementById('dev-login-form');
                    loginForm.style.display = loginForm.style.display === 'none' ? 'block' : 'none';
                }
            });
        });
    </script>
</body>
</html>